# AWS EKS VPC CNI Network Policy Simulator

## Overview

For anyone curious on how Network Policies are implemented in AWS EKS using the AWS VPC CNI plugin, this repo gives a 'stripped down' version of some of the components involved - no kubernetes required, just the minimum to have the same bpf programs running on the EKS nodes taking the final decision to ALLOW or DROP a packet.

The main flow at a very high level:
- an ebpf program is attached to to the [ingress](ebpf/c/tc.v4ingress.bpf.c) / [egress](ebpf/c/tc.v4egress.bpf.c) path on a host veth tc extension point
- _pod_ ip addresses (network namespaced containers) and other metdata are dynamically published by the user space __aws-network-policy-agent__ to ebpf maps shared with the ebpf programs
- the ebpf programs would ALLOW, DENY, PASS the packet depending on value of those ebpf maps shared with user space

For a deep dive on how this is implemented, see a [good enough overview](NETWORK_POLICY_EXPLAINED.md) generated by Claude Opus. Likely not all the details are right, but gives enough info to understand the flow and when ultimately the bpf programs are invoked.

Why this project? To learn and share how leveraging some simple linux primitives (defining _epbf_ programs on the linux _netdev_ _tc_ extension points) can yield advanced functionalities.

Demo:

https://github.com/user-attachments/assets/6380c6bf-5b33-4cfe-b375-4d69a4b083c0


## Quick Start

### Prerequisites

```bash
# Must run as root
sudo ./setup.sh
```

### Launch TUI

Must run as root

```bash
sudo ./run.sh
```


## How It Works


## License

- AWS VPC CNI source: Apache 2.0
- Modifications: Same (Apache 2.0)

## References

- [AWS Network Policy Agent](https://github.com/aws/aws-network-policy-agent)
- [eBPF TC Documentation](https://docs.kernel.org/bpf/prog_cgroup_sockopt.html)
- [BPF Type Format (BTF)](https://www.kernel.org/doc/html/latest/bpf/btf.html)
